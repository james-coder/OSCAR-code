name: Build OSCAR

on:
  push:
    branches:
      - master
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Tag name to create a GitHub release (leave empty to just build artifacts)"
        required: false
      release_name:
        description: "Release title (defaults to tag name)"
        required: false
      draft:
        description: "Publish as draft"
        required: false
        default: true
        type: boolean
      prerelease:
        description: "Mark as prerelease"
        required: false
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  linux:
    name: Linux (Qt 5)
    strategy:
      matrix:
        include:
          - os: ubuntu-20.04
            label: Ubuntu20
          - os: ubuntu-22.04
            label: Ubuntu22
          - os: ubuntu-24.04
            label: Ubuntu24
    runs-on: ${{ matrix.os }}
    env:
      CCACHE_DIR: ${{ github.workspace }}/.ccache
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            ccache \
            ruby ruby-dev \
            qtbase5-dev qtchooser qt5-qmake qtbase5-dev-tools qttools5-dev qttools5-dev-tools \
            libqt5serialport5-dev libqt5svg5-dev libqt5opengl5-dev \
            libudev-dev zlib1g-dev libgl1-mesa-dev
          sudo gem install --no-document fpm

      - name: Restore ccache
        uses: actions/cache@v4
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ccache-${{ matrix.os }}-${{ hashFiles('**/*.pro') }}
          restore-keys: |
            ccache-${{ matrix.os }}-

      - name: Configure
        run: |
          mkdir -p build
          cd build
          export PATH="/usr/lib/ccache:${PATH}"
          qmake QMAKE_LRELEASE=lrelease ../OSCAR_QT.pro CONFIG+=release

      - name: Build
        run: |
          cd build
          export PATH="/usr/lib/ccache:${PATH}"
          make -j"$(nproc)"

      - name: Package artifact
        run: |
          cd build/oscar
          extras=""
          for d in Translations Html Help; do
            [ -d "$d" ] && extras="$extras $d"
          done
          tar czf ../../OSCAR-linux.tar.gz OSCAR $extras

      - name: Build deb package
        run: |
          VERSION=$(sed -n 's/^#define VERSION "\(.*\)"/\1/p' oscar/VERSION)
          STAGE=/tmp/oscar-pkg
          rm -rf "$STAGE"
          mkdir -p "$STAGE/opt/oscar" "$STAGE/usr/bin"
          cp build/oscar/OSCAR "$STAGE/opt/oscar/"
          for d in Translations Html Help; do
            [ -d "build/oscar/$d" ] && cp -r "build/oscar/$d" "$STAGE/opt/oscar/"
          done
          cat > "$STAGE/usr/bin/oscar" <<'EOF'
#!/bin/sh
exec /opt/oscar/OSCAR "$@"
EOF
          chmod +x "$STAGE/usr/bin/oscar"
          fpm -s dir -t deb -n oscar -v "$VERSION" --architecture amd64 \
            --description "Open Source CPAP Analysis Reporter" \
            -d libqt5widgets5 -d libqt5gui5 -d libqt5network5 -d libqt5xml5 -d libqt5printsupport5 -d libqt5serialport5 -d libqt5opengl5 \
            -C "$STAGE" \
            --package "oscar_${VERSION}-${{ matrix.label }}_amd64-Qt5.deb"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: oscar-linux-${{ matrix.label }}
          path: |
            OSCAR-linux.tar.gz
            oscar_*${{ matrix.label }}_amd64-Qt5.deb

  debian:
    name: Debian (Qt 5)
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        include:
          - image: debian:bookworm-slim
            label: debian12
          - image: debian:trixie-slim
            label: debian13
    container:
      image: ${{ matrix.image }}
    env:
      CCACHE_DIR: /__w/OSCAR-code/OSCAR-code/.ccache
    steps:
      - name: Install build dependencies
        run: |
          apt-get update
          apt-get install -y git build-essential ccache \
            qtbase5-dev qttools5-dev qttools5-dev-tools \
            libqt5serialport5-dev libqt5svg5-dev libqt5opengl5-dev \
            libudev-dev zlib1g-dev libgl1-mesa-dev \
            ruby ruby-dev rpm
          gem install --no-document fpm

      - name: Checkout
        uses: actions/checkout@v4

      - name: Restore ccache
        uses: actions/cache@v4
        with:
          path: ${{ env.CCACHE_DIR }}
          key: ccache-${{ matrix.label }}-${{ hashFiles('**/*.pro') }}
          restore-keys: |
            ccache-${{ matrix.label }}-

      - name: Configure
        run: |
          mkdir -p build
          cd build
          export PATH="/usr/lib/ccache:${PATH}"
          qmake QMAKE_LRELEASE=lrelease ../OSCAR_QT.pro CONFIG+=release

      - name: Build
        run: |
          cd build
          export PATH="/usr/lib/ccache:${PATH}"
          make -j"$(nproc)"

      - name: Package artifact
        run: |
          cd build/oscar
          extras=""
          for d in Translations Html Help; do
            [ -d "$d" ] && extras="$extras $d"
          done
          tar czf "../../OSCAR-${{ matrix.label }}.tar.gz" OSCAR $extras

      - name: Build deb package
        run: |
          VERSION=$(sed -n 's/^#define VERSION "\(.*\)"/\1/p' oscar/VERSION)
          STAGE=/tmp/oscar-pkg
          rm -rf "$STAGE"
          mkdir -p "$STAGE/opt/oscar" "$STAGE/usr/bin"
          cp build/oscar/OSCAR "$STAGE/opt/oscar/"
          for d in Translations Html Help; do
            [ -d "build/oscar/$d" ] && cp -r "build/oscar/$d" "$STAGE/opt/oscar/"
          done
          cat > "$STAGE/usr/bin/oscar" <<'EOF'
#!/bin/sh
exec /opt/oscar/OSCAR "$@"
EOF
          chmod +x "$STAGE/usr/bin/oscar"
          fpm -s dir -t deb -n oscar -v "$VERSION" --architecture amd64 \
            --description "Open Source CPAP Analysis Reporter" \
            -d libqt5widgets5 -d libqt5gui5 -d libqt5network5 -d libqt5xml5 -d libqt5printsupport5 -d libqt5serialport5 -d libqt5opengl5 \
            -C "$STAGE" \
            --package "oscar_${VERSION}-${{ matrix.label }}_amd64-Qt5.deb"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: oscar-${{ matrix.label }}
          path: |
            OSCAR-${{ matrix.label }}.tar.gz
            oscar_*${{ matrix.label }}_amd64-Qt5.deb

  windows:
    name: Windows (Qt 5, MinGW)
    runs-on: windows-latest
    strategy:
        matrix:
          include:
            - qt_arch: win64_mingw81
              mingw_dir: mingw810_64
              arch_label: Win64
            - qt_arch: win32_mingw81
              mingw_dir: mingw810_32
              arch_label: Win32
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Sanitize PATH (remove WindowsApps python shim)
        shell: pwsh
        run: |
          $paths = $env:PATH -split ';' | Where-Object {$_ -notmatch 'WindowsApps'}
          "PATH=$($paths -join ';')" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: 5.15.2
          host: windows
          target: desktop
          arch: ${{ matrix.qt_arch }}
          tools: tools_mingw81
          cache: true

      - name: Add Qt and MinGW to PATH
        shell: bash
        run: |
          echo "$Qt5_DIR/bin" >> "$GITHUB_PATH"
          echo "$IQTA_TOOLS/${{ matrix.mingw_dir }}/bin" >> "$GITHUB_PATH"

      - name: Configure and build
        shell: bash
        run: |
          mkdir -p build
          cd build
          qmake DEFINES+=NO_LRELEASE ../OSCAR_QT.pro CONFIG+=release
          mingw32-make -j"$(nproc)"

      - name: Deploy runtime and resources
        shell: bash
        run: |
          cd build/oscar
          BIN=$(find .. -maxdepth 3 -name OSCAR.exe -print | head -n 1 || true)
          echo "Discovered OSCAR.exe at: ${BIN:-<not found>}"
          if [ -z "$BIN" ]; then
            echo "OSCAR executable not found"
            exit 1
          fi
          # Ensure the binary lives in release/
          mkdir -p release
          if [ "$BIN" != "release/OSCAR.exe" ]; then
            cp "$BIN" release/OSCAR.exe
          fi
          BIN="release/OSCAR.exe"
          for d in Translations Html Help; do
            if [ -d "../$d" ]; then
              cp -r "../$d" "release/$d"
            fi
          done
          PLUGIN_DIR=$(cygpath -w "$Qt5_DIR/plugins")
          export QT_PLUGIN_PATH="$PLUGIN_DIR"
          WINDEPLOY=$(cygpath -w "$Qt5_DIR/bin/windeployqt.exe")
          cmd.exe /c "$WINDEPLOY --release $(cygpath -w "$BIN")"

      - name: Rename Windows binary
        shell: bash
        run: |
          VERSION=$(sed -n 's/^#define VERSION "\(.*\)"/\1/p' oscar/VERSION)
          cd build/oscar/release
          mv OSCAR.exe "OSCAR-${VERSION}-${{ matrix.arch_label }}-Qt5.exe"

      - name: Archive artifact
        shell: bash
        run: |
          cd build/oscar/release
          7z a "../../../OSCAR-${{ matrix.arch_label }}.zip" .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: oscar-windows-${{ matrix.arch_label }}
          path: "OSCAR-${{ matrix.arch_label }}.zip"

  macos:
    name: macOS (Qt 5)
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: 5.15.2
          host: mac
          target: desktop
          arch: clang_64
          cache: true

      - name: Configure
        run: |
          mkdir -p build
          cd build
          qmake QMAKE_LRELEASE=lrelease ../OSCAR_QT.pro CONFIG+=release

      - name: Build
        run: |
          cd build
          make -j"$(sysctl -n hw.logicalcpu)"

      - name: Deploy app bundle
        run: |
          cd build/oscar
          macdeployqt OSCAR.app -dmg

      - name: Rename DMG to include version and Qt suffix
        run: |
          VERSION=$(grep -oE '#define VERSION "[^"]+' oscar/VERSION | sed 's/.*"//')
          cd build/oscar
          mv OSCAR.dmg "OSCAR-${VERSION}-Qt5.dmg"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: oscar-macos
          path: |
            build/oscar/OSCAR.app
            build/oscar/OSCAR-*-Qt5.dmg

  release:
    name: Publish release
    needs: [linux, windows, macos]
    if: ${{ github.event.inputs.release_tag != '' }}
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts

      - name: Collect release files
        shell: bash
        run: |
          mkdir -p dist
          # Linux tarball
          for f in release-artifacts/oscar-linux-*/**/*.tar.gz; do
            [ -f "$f" ] && cp "$f" dist/
          done
          for f in release-artifacts/oscar-linux-*/**/*.deb; do
            [ -f "$f" ] && cp "$f" dist/
          done
          # Debian tarballs
          for f in release-artifacts/oscar-debian12/*.tar.gz; do
            [ -f "$f" ] && cp "$f" dist/
          done
          for f in release-artifacts/oscar-debian13/*.tar.gz; do
            [ -f "$f" ] && cp "$f" dist/
          done
          for f in release-artifacts/oscar-debian12/*.deb; do
            [ -f "$f" ] && cp "$f" dist/
          done
          for f in release-artifacts/oscar-debian13/*.deb; do
            [ -f "$f" ] && cp "$f" dist/
          done
          # macOS dmg
          find release-artifacts -type f -name 'OSCAR-*-Qt5.dmg' -exec cp '{}' dist/ \; || true
          # Windows zips
          if [ -f release-artifacts/oscar-windows-Win64/OSCAR-Win64.zip ]; then
            cp release-artifacts/oscar-windows-Win64/OSCAR-Win64.zip dist/
          fi
          if [ -f release-artifacts/oscar-windows-Win32/OSCAR-Win32.zip ]; then
            cp release-artifacts/oscar-windows-Win32/OSCAR-Win32.zip dist/
          fi
          ls -l dist

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.release_tag }}
          name: ${{ github.event.inputs.release_name || github.event.inputs.release_tag }}
          draft: ${{ github.event.inputs.draft }}
          prerelease: ${{ github.event.inputs.prerelease }}
          target_commitish: ${{ github.sha }}
          files: dist/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
